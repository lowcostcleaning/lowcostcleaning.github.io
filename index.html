<script>
  const SHEET_ID = "1RuT1hrD76olFtMu4JDV5D9d5ocZ9Hlg5xQG3Wl9UInE";
  const SHEET_RANGE = "A:B";
  const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=–õ–∏—Å—Ç1&range=${SHEET_RANGE}`;

  let selectedService = "";
  let selectedDate = "";

  async function getBusyDates() {
    try {
      const res = await fetch(API_URL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows;
      const busy = [];

      for (const r of rows) {
        if (!r.c[0] || !r.c[1]) continue;
        const rawDate = r.c[0].v;
        const status = (r.c[1].v || "").toLowerCase();

        // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
        const d = new Date(rawDate);
        const normalized = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;

        if (status.includes("–∑–∞–Ω—è—Ç–æ")) busy.push(normalized);
      }

      console.log("üìÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞–Ω—è—Ç—ã–µ –¥–∞—Ç—ã:", busy);
      return busy;
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets:", err);
      return [];
    }
  }

  async function chooseService(service) {
    selectedService = service;
    document.getElementById("calendarContainer").style.display = "flex";
    await generateCalendar();
    window.scrollTo({ top: document.getElementById("calendarContainer").offsetTop - 50, behavior: "smooth" });
  }

  async function generateCalendar() {
    const busyDates = await getBusyDates();

    const calendar = document.getElementById("calendar");
    const monthLabel = document.getElementById("monthLabel");
    calendar.innerHTML = "";

    const year = 2025, month = 9;
    const monthName = new Date(year, month).toLocaleString("ru-RU", { month: "long", year: "numeric" });
    monthLabel.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

    const firstDay = new Date(year, month, 1).getDay();
    const offset = (firstDay === 0 ? 6 : firstDay - 1);
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();

    // —à–∞–ø–∫–∞ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
    let html = "<tr>";
    const weekDays = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
    html += weekDays.map(d => `<th>${d}</th>`).join("") + `</tr><tr>`;

    for (let i = 0; i < offset; i++) html += `<td></td>`;

    for (let i = 1; i <= daysInMonth; i++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
      const dateObj = new Date(dateStr);
      let className = "available";
      let click = `onclick="openModal('${dateStr}')"`;

      if (busyDates.includes(dateStr)) {
        className = "unavailable";
        click = "";
      } else if (dateObj < today) {
        className = "past";
        click = "";
      }

      html += `<td class="day ${className}" ${click}>${i}</td>`;
      if ((i + offset) % 7 === 0) html += `</tr><tr>`;
    }

    html += `</tr>`;
    calendar.innerHTML = html;
  }

  const modal = document.getElementById("bookingModal");
  function openModal(date) {
    selectedDate = date;
    document.getElementById("modalTitle").innerText = `${selectedService}\nüìÖ ${date}`;
    modal.style.display = "flex";
  }
  function closeModal() { modal.style.display = "none"; }

  function sendBooking() {
    const name = document.getElementById("clientName").value.trim();
    const phone = document.getElementById("clientPhone").value.trim();
    if (!name || !phone) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω"); return; }
    const message = encodeURIComponent(`üßπ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–∞ —É–±–æ—Ä–∫—É:\n${selectedService}\nüìÖ ${selectedDate}\nüë§ –ò–º—è: ${name}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: ${phone}`);
    const telegramLink = `https://t.me/kalendaruborok_bot?text=${message}`;
    window.open(telegramLink, "_blank");
    closeModal();
  }
</script>
